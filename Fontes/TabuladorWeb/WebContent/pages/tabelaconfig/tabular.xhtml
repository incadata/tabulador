<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:fn="http://java.sun.com/jsp/jstl/functions">
<h:head>
	<title><h:outputText value="#{msg['table_data']}" /></title>
</h:head>

<h:body>
	<h1><h:outputText value="#{msg['table_data']}" /></h1>
	<p:messages id="messages" showDetail="true" autoUpdate="true" closable="true" />

	<f:metadata>
    	<f:viewParam name="entity.id" value="#{tabularView.tabelaConfig.id}" />
    	<f:viewParam name="converter" value="#{tabularView.converter}" />
    	<f:viewAction action="#{tabularView.findById(tabularView.tabelaConfig.id)}"/>
	</f:metadata>

	<h2>
		<h:outputText value="#{tabularView.tabelaConfig.nome}" />
		<h:outputText value=" - " />
		<h:outputText value="#{tabularView.tabelaConfig.titulo}" />
	</h2>
	<h:form id="formTabular">
		<p:panelGrid columns="2" layout="grid">
			<h:outputText value="#{msg['lines_per_page']}: " />
			<p:selectOneMenu value="#{tabularView.resultadosPorPagina}" process="@this" update="panelResultado" title="#{msg['lines_per_page']}">
				<f:selectItem itemLabel="5" itemValue="5" />
				<f:selectItem itemLabel="10" itemValue="10" />
				<f:selectItem itemLabel="20" itemValue="20" />
				<f:selectItem itemLabel="50" itemValue="50" />
				<f:selectItem itemLabel="100" itemValue="100" />
				<f:selectItem itemLabel="Todos" itemValue="0" />
			</p:selectOneMenu>
		</p:panelGrid>

		<p:carousel value="#{tabularView.campos}" var="filtro" id="filtrosCarousel" binding="#{carouselFiltro}"
	    	headerText="#{msg['filter']}" itemStyle="text-align:center" responsive="true">
	        <p:panelGrid columns="1" id="campoAtual"
	        	style="width:100%;margin:10px 0px" columnClasses="label,value" layout="grid"
	        	styleClass="ui-panelgrid-blank">

		        <p:selectOneMenu id="filtroCampoSelect" value="#{filtro.campo}" title="#{msg['filter_field']}" converter="entityConverter">
					<f:selectItems value="#{tabularView.camposFiltro}" var="tipoCampoIt"
						itemLabel="#{tipoCampoIt.labelOrNome}" itemValue="#{tipoCampoIt}" />
					<f:ajax execute="campoAtual" render="campoAtual"/>
				</p:selectOneMenu>

				<p:selectOneMenu value="#{filtro.filtro}" title="#{msg['filter']}" converter="entityConverter">
					<f:selectItems value="#{tipoFiltroView.entities}" var="filterIt"
						itemLabel='#{filterIt.nome}' itemValue="#{filterIt}" />
					<f:ajax execute="campoAtual" render="campoAtual"/>
				</p:selectOneMenu>
		        <ui:fragment rendered="#{empty filtro.campo.valores}">
					<p:inputText value="#{filtro.value}" placeholder="#{msg['value']}" rendered="#{!filtro.campo.tipoCampo.isData()}"/>
					<p:calendar value="#{filtro.value}" placeholder="#{msg['value']}" pattern="#{filtro.pattern}" rendered="#{filtro.campo.tipoCampo.isData()}"/>
		        </ui:fragment>
				<ui:fragment rendered="#{not empty filtro.campo.valores}">
					<p:pickList rendered="#{filtro.filtro.multiplo}"
						value="#{filtro.valores}" var="valor" converter="entityConverter" responsive="true" style="layout: auto;"
						itemLabel="#{valor.codigoDescricao}" itemValue="#{valor}">
					</p:pickList>
			        <p:selectOneMenu value="#{filtro.value}" title="#{msg['value']}" rendered="#{!filtro.filtro.multiplo}">
			        	<f:selectItem itemLabel="- Selecione -" itemValue="" />
						<f:selectItems value="#{filtro.campo.valores}" var="valueIt"
							itemLabel='#{valueIt.codigoDescricao}' itemValue="#{valueIt.codigo}" />
					</p:selectOneMenu>
				</ui:fragment>

				<f:facet name="header">
					<p:commandButton icon="ui-icon-minus" title="#{msg['remove_filter']}" 
						actionListener="#{tabularView.removerFiltro(carouselFiltro.rowIndex)}" update="filtrosCarousel"/>
	            </f:facet>
	        </p:panelGrid>

	        <f:facet name="footer">
        		<p:commandButton icon="ui-icon-plus" title="#{msg['add_column']}" value="#{msg['add']}"
        			actionListener="#{tabularView.addCampo}" process="filtrosCarousel" update="filtrosCarousel"/>
                Total de filtros: #{fn:length(tabularView.campos)}
	        </f:facet>
	    </p:carousel>

	    <br />

		<p:carousel value="#{tabularView.camposAgrupar}" var="agrupador" id="agruparCarousel" binding="#{carouselAgrupador}"
	    	headerText='#{tabularView.converter ? "Linha / Coluna" : "Colunas" }' itemStyle="text-align:center" responsive="true">
			<p:panelGrid id="agrupadorAtual" columns="1"
	        	style="width:100%;margin:10px 0px" columnClasses="label,value" layout="grid"
	        	styleClass="ui-panelgrid-blank">
		    	<p:selectOneMenu value="#{agrupador.id}" update="agruparCarousel" style="responsive" title="#{msg['group_field']}">
					<f:selectItems value="#{tabularView.tabelaConfig.campos}" var="tipoCampoIt"
						itemLabel="#{tipoCampoIt.labelOrNome}" itemValue="#{tipoCampoIt.id}" />
				</p:selectOneMenu>

				<f:facet name="header">
					<p:commandButton icon="ui-icon-minus" title="#{msg['remove_group_by']}" 
						actionListener="#{tabularView.removerCampoAgrupar(carouselAgrupador.rowIndex)}" update="agruparCarousel"/>
	            </f:facet>
        	</p:panelGrid>

	    	<f:facet name="footer">
        		<p:commandButton icon="ui-icon-plus" title="#{msg['add_column']}" value="#{msg['add']}"
        			actionListener="#{tabularView.addCampoAgrupar}" update="agruparCarousel"/>
                Total de agrupadores: #{fn:length(tabularView.camposAgrupar)}
	        </f:facet>
    	</p:carousel>

		<p>
			<p:commandButton value="#{msg['to_table']}" icon="ui-icon-grip-dotted-vertical" actionListener="#{tabularView.tabular}" process="@form" update="panelResultado"/>
			<p:commandButton value="#{msg['cancel']}" icon="ui-icon-cancel" action="consultar"/>
		</p>

		<h:panelGroup id="panelResultado">
			<h2><h:outputText value="#{msg['result']}" rendered="#{not empty tabularView.resultado.columns}"/></h2>

			<p:dataTable id="tabelaResultado" var="line" value="#{tabularView.resultado.lines}" rendered="#{not empty tabularView.resultado.columns}"
			    paginator="true" rows="#{tabularView.resultadosPorPagina}" emptyMessage="#{msg['table_empty_msg']}">
			    <f:facet name="header">
		            <h:outputText value="#{tabularView.tabelaConfig.tituloOrNome}" />
        		</f:facet>
		        <p:columns value="#{tabularView.resultado.columns}" var="column" columnIndexVar="colIndex" sortBy="#{tabularView.resultado.convertValor(column, line.get(column))}">
		            <f:facet name="header">
		                <h:outputText value="#{column.labelOrNome}" />
		            </f:facet>
		            <h:outputText value="#{tabularView.resultado.convertValor(column, line.get(column))}" />
		        </p:columns>

				<f:facet name="footer">
					<h:commandLink>
						<p:commandButton value="xls" />
						<p:dataExporter type="xls" target="tabelaResultado" fileName="tabular" encoding="UTF-8"/>
					</h:commandLink>

					<h:commandLink>
						<p:commandButton value="pdf" />
						<p:dataExporter type="pdf" target="tabelaResultado" fileName="tabular" encoding="UTF-8"/>
					</h:commandLink>

					<h:commandLink>
						<p:commandButton value="csv" />
						<p:dataExporter type="csv" target="tabelaResultado" fileName="tabular" encoding="UTF-8"/>
					</h:commandLink>

					<h:commandLink>
						<p:commandButton value="xml" />
						<p:dataExporter type="xml" target="tabelaResultado" fileName="tabular" encoding="UTF-8"/>
					</h:commandLink>
				</f:facet>
			</p:dataTable>
		</h:panelGroup>
	</h:form>
</h:body>
</html>