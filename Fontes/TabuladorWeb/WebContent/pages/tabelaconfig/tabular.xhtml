<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:fn="http://java.sun.com/jsp/jstl/functions">
<h:head>
	<title>Tabular dados</title>
</h:head>

<h:body>
	<h1>Tabular dados</h1>
	<p:messages id="messages" showDetail="true" autoUpdate="true" closable="true" />

	<f:metadata>
    	<f:viewParam name="entity.id" value="#{tabularView.tabelaConfig.id}" />
    	<f:viewParam name="converter" value="#{tabularView.converter}" />
    	<f:viewAction action="#{tabularView.findById(tabularView.tabelaConfig.id)}"/>
	</f:metadata>

	<h2>
		<h:outputText value="#{tabularView.tabelaConfig.nome}" />
		<h:outputText value=" - " />
		<h:outputText value="#{tabularView.tabelaConfig.titulo}" />
	</h2>

	<h:form id="formTabular">
		<p:carousel value="#{tabularView.campos}" var="filtro" id="filtrosCarousel" binding="#{carouselFiltro}"
	    	headerText="Filtro" itemStyle="text-align:center" responsive="true">
	        <p:panelGrid columns="1" id="campoAtual"
	        	style="width:100%;margin:10px 0px" columnClasses="label,value" layout="grid"
	        	styleClass="ui-panelgrid-blank">

		        <p:selectOneMenu value="#{filtro.id}" update="filtrosCarousel" style="responsive" title="Campo do filtro">
					<f:selectItems value="#{tabularView.camposFiltro}" var="tipoCampoIt"
						itemLabel="#{tipoCampoIt.nome}" itemValue="#{tipoCampoIt.id}" />
					<f:ajax listener="#{tabularView.atualizarTipoCampo(carouselFiltro.rowIndex)}" render="campoAtual" />
				</p:selectOneMenu>

		        <!-- 
		        <p:selectOneMenu value="#{filtro.tipoFiltro.id}" update="filtrosCarousel" style="responsive" title="Tipo do filtro">
					<f:selectItems value="#{tipoFiltroView.entities}" var="tipoFiltroIt"
						itemLabel="#{tipoFiltroIt.nome}" itemValue="#{tipoFiltroIt.id}" />
				</p:selectOneMenu>
		         -->

				<p:inputText value="#{filtro.value}" placeholder="Valor"/>

				<f:facet name="header">
					<p:commandButton icon="ui-icon-minus" title="Remover filtro" 
						actionListener="#{tabularView.removerCampo(carouselFiltro.rowIndex)}" update="filtrosCarousel"/>
	            </f:facet>
	        </p:panelGrid>

	        <f:facet name="footer">
        		<p:commandButton icon="ui-icon-plus" title="Adicionar coluna" value="Adicionar"
        			actionListener="#{tabularView.addCampo}" update="filtrosCarousel"/>
                Total de filtros: #{fn:length(tabularView.campos)}
	        </f:facet>
	    </p:carousel>

	    <br />

		<p:carousel value="#{tabularView.camposAgrupar}" var="agrupador" id="agruparCarousel" binding="#{carouselAgrupador}"
	    	headerText="Linha / Coluna" itemStyle="text-align:center" responsive="true">
			<p:panelGrid id="agrupadorAtual" columns="1"
	        	style="width:100%;margin:10px 0px" columnClasses="label,value" layout="grid"
	        	styleClass="ui-panelgrid-blank">
		    	<p:selectOneMenu value="#{agrupador.id}" update="agruparCarousel" style="responsive" title="Campo do agrupador">
					<f:selectItems value="#{tabularView.tabelaConfig.campos}" var="tipoCampoIt"
						itemLabel="#{tipoCampoIt.nome}" itemValue="#{tipoCampoIt.id}" />
				</p:selectOneMenu>

				<f:facet name="header">
					<p:commandButton icon="ui-icon-minus" title="Remover agrupador" 
						actionListener="#{tabularView.removerCampoAgrupar(carouselAgrupador.rowIndex)}" update="agruparCarousel"/>
	            </f:facet>
        	</p:panelGrid>

	    	<f:facet name="footer">
        		<p:commandButton icon="ui-icon-plus" title="Adicionar coluna" value="Adicionar"
        			actionListener="#{tabularView.addCampoAgrupar}" update="agruparCarousel"/>
                Total de agrupadores: #{fn:length(tabularView.camposAgrupar)}
	        </f:facet>
    	</p:carousel>

		<p>
			<p:commandButton value="Tabular" icon="ui-icon-grip-dotted-vertical" actionListener="#{tabularView.tabular}" update="panelResultado"/>
			<p:commandButton value="Cancelar" icon="ui-icon-cancel" action="consultar"/>
		</p>

		<h:panelGroup id="panelResultado">
			<h2><h:outputText value="Resultado" rendered="#{not empty tabularView.resultado.columns}"/></h2>

			<p:dataTable id="tabelaResultado" var="line" value="#{tabularView.resultado.lines}" rendered="#{not empty tabularView.resultado.columns}"
			    paginator="true">
		        <p:columns value="#{tabularView.resultado.columns}" var="column" columnIndexVar="colIndex">
		            <f:facet name="header">
		                <h:outputText value="#{column.labelOrNome}" />
		            </f:facet>
		            <h:outputText value="#{tabularView.resultado.convertValor(column, line.get(column))}" />
		        </p:columns>

				<f:facet name="footer">
					<h:commandLink>
						<p:commandButton value="xls" />
						<p:dataExporter type="xls" target="tabelaResultado" fileName="tabular" encoding="UTF-8"/>
					</h:commandLink>

					<h:commandLink>
						<p:commandButton value="pdf" />
						<p:dataExporter type="pdf" target="tabelaResultado" fileName="tabular" encoding="UTF-8"/>
					</h:commandLink>

					<h:commandLink>
						<p:commandButton value="csv" />
						<p:dataExporter type="csv" target="tabelaResultado" fileName="tabular" encoding="UTF-8"/>
					</h:commandLink>

					<h:commandLink>
						<p:commandButton value="xml" />
						<p:dataExporter type="xml" target="tabelaResultado" fileName="tabular" encoding="UTF-8"/>
					</h:commandLink>
				</f:facet>
			</p:dataTable>
		</h:panelGroup>
	</h:form>
</h:body>
</html>